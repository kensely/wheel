<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>é¦¬åˆ°æˆåŠŸï¼šæ¨‚é€é‡‘å¤§è½‰ç›¤</title>
    
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+TC:wght@400;700;900&family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
    
    <style>
      html, body {
        overscroll-behavior: none;
        height: 100%; width: 100%;
        background: #2a0505;
        margin: 0; overflow: hidden;
      }
      body {
        font-family: 'Noto Sans TC', sans-serif;
        background: radial-gradient(circle at center, #7f1d1d 0%, #2a0505 100%);
      }
      .font-calligraphy { font-family: 'Ma Shan Zheng', cursive; }
      
      .particle {
        position: fixed; pointer-events: none;
        background: linear-gradient(135deg, #f59e0b, transparent);
        border-radius: 50%; opacity: 0.3;
        animation: float-up linear infinite;
        z-index: 1;
      }
      @keyframes float-up {
        0% { transform: translateY(110vh) translateX(0) scale(1); opacity: 0; }
        20% { opacity: 0.4; }
        100% { transform: translateY(-10vh) translateX(50px) scale(0.5); opacity: 0; }
      }

      .game-container {
        position: relative; z-index: 10;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        min-height: 100vh; padding: 20px;
      }
      .wheel-outer {
        position: relative;
        width: 320px; height: 320px;
        border: 8px solid #f59e0b;
        border-radius: 50%;
        box-shadow: 0 0 50px rgba(0,0,0,0.8), inset 0 0 20px rgba(245,158,11,0.5);
        background: #f59e0b;
        margin: 20px auto;
      }
      #wheel-canvas { width: 100%; height: 100%; border-radius: 50%; }
      
      .pointer {
        position: absolute; top: -25px; left: 50%;
        transform: translateX(-50%); width: 40px;
        z-index: 30; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.8));
      }

      .spin-btn {
        position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: 70px; height: 70px;
        background: radial-gradient(#fff, #f59e0b);
        color: #7f1d1d; border-radius: 50%;
        font-weight: 900; border: 4px solid #7f1d1d;
        z-index: 40; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5); cursor: pointer;
      }
      .spin-btn:active { transform: translate(-50%, -46%); box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
      
      #loading-overlay {
        position: fixed; inset: 0; z-index: 9999;
        background: radial-gradient(circle at center, #7f1d1d 0%, #2a0505 100%);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
      }
    </style>
  </head>
  <body>
    <div id="loading-overlay">
      <div class="text-6xl mb-4 animate-bounce">ğŸ§§</div>
      <div id="loading-text" class="text-xl font-bold font-calligraphy text-amber-400">æ­£åœ¨ç¢ºèªé–‹é‹è³‡æ ¼...</div>
    </div>

    <div id="bg-particles"></div>

    <div class="game-container">
      <h1 class="text-5xl font-calligraphy text-yellow-500 mb-2 drop-shadow-2xl">é¦¬åˆ°æˆåŠŸ</h1>
      <p class="text-yellow-600/60 text-sm tracking-[0.3em] mb-10 font-bold italic">LOTTO GOLD SPIN</p>

      <div class="wheel-outer">
        <img src="https://cdn-icons-png.flaticon.com/512/8215/8215539.png" class="pointer" alt="pointer">
        <canvas id="wheel-canvas"></canvas>
        <div id="spin-btn" class="spin-btn" onclick="startSpin()">æŠ½ç</div>
      </div>

      <div id="status-msg" class="mt-12 p-4 rounded-2xl bg-white/5 border border-white/10 backdrop-blur-md text-yellow-200/80 text-sm tracking-widest text-center">
        è½‰å‹•å¤§è½‰ç›¤ï¼Œè´å–æ¨‚é€é‡‘çå‹µ
      </div>
    </div>

    <script>
      const LIFF_ID = '1569792743-2S9Zy8IT';
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbwsmCxklPsVoozRdPggUmh81IXatVZfWEG9dAD7iDkNwQHWJKoJe-idX4BLmF1_GLzZGg/exec';
      let userUID = "";
      let isSpinning = false;

      // æ›´æ–°å¾Œçš„çé …åå–®
      const prizes = [
        { name: "5 æ¨‚é€é‡‘", color: "#7f1d1d" },
        { name: "10 æ¨‚é€é‡‘", color: "#3d0a0a" },
        { name: "15 æ¨‚é€é‡‘", color: "#991b1b" },
        { name: "20 æ¨‚é€é‡‘", color: "#450a0a" }
      ];

      async function init() {
        drawWheel();
        createParticles();
        try {
          await liff.init({ liffId: LIFF_ID });
          if (!liff.isLoggedIn()) { liff.login(); return; }
          const profile = await liff.getProfile();
          userUID = profile.userId;

          const res = await fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'check', userId: userUID })
          });
          const data = await res.json();
          if (data.canPlay) {
            document.getElementById('loading-overlay').style.display = 'none';
          } else {
            document.getElementById('loading-text').innerHTML = "âŒ æ‚¨å·²åƒåŠ éæœ¬æ´»å‹•<br><small>æ¯ä½æœƒå“¡é™åƒåŠ ä¸€æ¬¡</small>";
          }
        } catch (e) {
          document.getElementById('loading-overlay').style.display = 'none';
        }
      }

      function drawWheel() {
        const canvas = document.getElementById('wheel-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 800; canvas.height = 800;
        const cx = 400, cy = 400, r = 380;
        const step = (Math.PI * 2) / prizes.length;

        prizes.forEach((p, i) => {
          const angle = i * step;
          ctx.beginPath();
          ctx.fillStyle = p.color;
          ctx.moveTo(cx, cy);
          ctx.arc(cx, cy, r, angle, angle + step);
          ctx.fill();
          ctx.strokeStyle = "rgba(245,158,11,0.5)";
          ctx.lineWidth = 4;
          ctx.stroke();

          ctx.save();
          ctx.translate(cx, cy);
          ctx.rotate(angle + step / 2);
          ctx.fillStyle = "#fbbf24";
          ctx.font = "bold 50px Noto Sans TC";
          ctx.textAlign = "right";
          ctx.fillText(p.name, r - 60, 18);
          ctx.restore();
        });
      }

      function startSpin() {
        if (isSpinning) return;
        isSpinning = true;
        document.getElementById('spin-btn').style.opacity = "0.5";
        document.getElementById('status-msg').innerText = "ğŸ”® æ¨‚é€é‡‘å¥½é‹è¨ˆç®—ä¸­...";

        const winIndex = Math.floor(Math.random() * prizes.length);
        const totalRotation = 3600 + (360 - (winIndex * (360 / prizes.length)) - (180 / prizes.length));

        gsap.to("#wheel-canvas", {
          rotation: totalRotation,
          duration: 5,
          ease: "back.out(0.4)",
          onComplete: () => {
            handleResult(prizes[winIndex].name);
          }
        });
      }

      async function handleResult(prize) {
        document.getElementById('status-msg').innerHTML = `ğŸŠ æ­å–œç²å¾—ï¼š<span class="text-yellow-400 font-bold text-2xl">${prize}</span>`;
        await fetch(GAS_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'save', userId: userUID, prize: prize })
        });
      }

      function createParticles() {
        const container = document.getElementById('bg-particles');
        for (let i = 0; i < 20; i++) {
          const p = document.createElement('div');
          p.className = 'particle';
          const size = Math.random() * 5 + 2 + 'px';
          p.style.width = size; p.style.height = size;
          p.style.left = Math.random() * 100 + 'vw';
          p.style.animationDuration = Math.random() * 10 + 5 + 's';
          p.style.animationDelay = Math.random() * 5 + 's';
          container.appendChild(p);
        }
      }

      window.onload = init;
    </script>
  </body>
</html>
