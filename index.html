<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é¦¬åˆ°æˆåŠŸï¼šåˆé¦¬é–‹é‹å¤§è¼ªç›¤</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background: radial-gradient(circle at center, #7f1d1d 0%, #2a0505 100%);
            color: #fff; min-height: 100vh; margin: 0; overflow-x: hidden;
        }
        .font-calligraphy { font-family: 'Ma Shan Zheng', cursive; }
        
        /* èƒŒæ™¯é‡‘ç²‰ç²’å­ */
        #bg-particles { position: fixed; inset: 0; pointer-events: none; z-index: 1; }
        .particle { position: absolute; background: linear-gradient(135deg, #f59e0b, transparent); border-radius: 50%; opacity: 0.3; animation: float-up linear infinite; }
        @keyframes float-up { 
            0% { transform: translateY(110vh) scale(1); opacity: 0; } 
            100% { transform: translateY(-10vh) scale(0.5); opacity: 0; } 
        }

        /* ç£¨ç ‚ç»ç’ƒæ•ˆæœ */
        .glass-panel { 
            background: linear-gradient(to bottom, rgba(58, 10, 10, 0.9), #000); 
            border: 1px solid rgba(202, 138, 4, 0.3); 
            backdrop-filter: blur(10px);
        }

        /* åˆå§‹åŠ è¼‰é®ç½© */
        #loading-overlay { 
            position: fixed; inset: 0; z-index: 999; background: #2a0505; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }

        /* ä¸­çå½ˆçª—æ¨£å¼ */
        #prize-modal { 
            display: none; position: fixed; inset: 0; z-index: 1000; 
            background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); 
            align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="text-6xl mb-4 animate-bounce">ğŸ§§</div>
        <p class="text-yellow-500 font-calligraphy text-2xl tracking-widest">å•Ÿå‹•å¥½é‹ä¸­...</p>
    </div>

    <div id="bg-particles"></div>

    <main class="relative z-10 flex flex-col items-center px-6 py-12">
        <header class="text-center mb-12">
            <h1 class="text-6xl font-calligraphy text-yellow-500 mb-4 drop-shadow-2xl">é¦¬åˆ°æˆåŠŸ</h1>
            <div class="flex items-center justify-center gap-4 text-yellow-600/60 font-bold tracking-[0.4em] text-[10px]">
                <div class="h-px w-8 bg-current"></div>
                <span>LUCKY WHEEL</span>
                <div class="h-px w-8 bg-current"></div>
            </div>
        </header>

        <div class="relative w-[320px] h-[320px] mb-16">
            <div class="absolute inset-0 rounded-full border-[10px] border-yellow-600/20 bg-black/40 shadow-[0_0_50px_rgba(0,0,0,0.5)]"></div>
            <img src="https://cdn-icons-png.flaticon.com/512/8215/8215539.png" class="absolute -top-7 left-1/2 -translate-x-1/2 w-14 z-20 drop-shadow-lg" alt="pointer">
            <canvas id="wheel-canvas" class="rounded-full"></canvas>
            <button id="spin-btn" onclick="startSpin()" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-20 h-20 bg-gradient-to-b from-yellow-400 via-yellow-600 to-yellow-800 rounded-full border-4 border-[#2a0505] shadow-2xl z-30 font-black text-[#2a0505] text-xl active:scale-90 transition-transform">
                æŠ½ç
            </button>
        </div>

        <section class="w-full max-w-[360px] glass-panel rounded-[40px] p-10 shadow-2xl">
            <h2 class="font-calligraphy text-3xl text-yellow-500 text-center mb-10 tracking-widest">æ´»å‹•èªªæ˜</h2>
            <div class="space-y-6" id="rules-container">
                </div>
        </section>

        <button onclick="liff.closeWindow()" class="mt-12 text-white/20 underline text-[10px] tracking-widest">é›¢é–‹é é¢</button>
    </main>

    <div id="prize-modal">
        <div class="bg-gradient-to-b from-[#3a0a0a] to-black border-2 border-yellow-500 p-12 rounded-[40px] text-center max-w-[300px] transform scale-90 transition-transform duration-300">
            <div class="text-6xl mb-6">ğŸŠ</div>
            <h3 class="text-yellow-500 font-calligraphy text-3xl mb-4">æ­å–œä¸­ç</h3>
            <div id="win-name" class="text-4xl font-black text-white mb-8"></div>
            <button onclick="closeModal()" class="w-full py-4 bg-yellow-500 text-black font-bold rounded-full shadow-lg">é ˜å–ä¸¦é—œé–‰</button>
        </div>
    </div>

    <script>
        const LIFF_ID = '1569792743-2S9Zy8IT';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwsmCxklPsVoozRdPggUmh81IXatVZfWEG9dAD7iDkNwQHWJKoJe-idX4BLmF1_GLzZGg/exec';
        
        const rules = [
            "æ¯ä½æœƒå“¡é™åƒåŠ ä¸€æ¬¡åˆé¦¬é–‹é‹å¤§è¼ªç›¤æ´»å‹•ã€‚",
            "æŠ½ä¸­ä¹‹æ¨‚é€é‡‘çé …å°‡æ–¼ 24 å°æ™‚å…§è‡ªå‹•ç™¼é€è‡³æ‚¨çš„æœƒå“¡å¸³æˆ¶ã€‚",
            "æ¨‚é€é‡‘ä½¿ç”¨è¦ç¯„è«‹åƒé–±æœ¬å¹³å°ä¹‹æœƒå“¡æœå‹™å”è­°ã€‚",
            "è‹¥åµæ¸¬åˆ°é‡è¤‡é ˜å–æˆ–ç•°å¸¸æ“ä½œï¼Œç³»çµ±å°‡è‡ªå‹•å–æ¶ˆçé …è³‡æ ¼ã€‚",
            "ä¸»è¾¦å–®ä½ä¿æœ‰æ´»å‹•æœ€çµ‚ä¿®æ”¹ã€è®Šæ›´åŠè§£é‡‹ä¹‹æ¬Šåˆ©ã€‚"
        ];

        const prizes = [
            { name: "5 æ¨‚é€é‡‘", color: "#7f1d1d" }, { name: "10 æ¨‚é€é‡‘", color: "#2a0505" },
            { name: "15 æ¨‚é€é‡‘", color: "#991b1b" }, { name: "20 æ¨‚é€é‡‘", color: "#450a0a" }
        ];

        let userUID = "";
        let isSpinning = false;

        async function init() {
            // æ¸²æŸ“æ–‡æ¡ˆ
            document.getElementById('rules-container').innerHTML = rules.map((r, i) => `
                <div class="flex gap-4">
                    <span class="flex-shrink-0 w-6 h-6 rounded-full bg-yellow-600/20 border border-yellow-600/40 flex items-center justify-center text-yellow-500 text-[10px] font-black">${i+1}</span>
                    <p class="text-white/70 text-xs leading-relaxed font-medium">${r}</p>
                </div>
            `).join('');

            // ç¹ªè£½è¼ªç›¤
            const canvas = document.getElementById('wheel-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 800; canvas.height = 800;
            const cx = 400, cy = 400, r = 380, step = (Math.PI * 2) / prizes.length;
            prizes.forEach((p, i) => {
                const angle = i * step;
                ctx.beginPath(); ctx.fillStyle = p.color; ctx.moveTo(cx, cy); ctx.arc(cx, cy, r, angle, angle + step); ctx.fill();
                ctx.save(); ctx.translate(cx, cy); ctx.rotate(angle + step / 2); ctx.fillStyle = "#fbbf24"; ctx.font = "bold 52px Noto Sans TC"; ctx.textAlign = "right";
                ctx.fillText(p.name, r - 60, 20); ctx.restore();
            });

            // ç”Ÿæˆç²’å­
            const partContainer = document.getElementById('bg-particles');
            for(let i=0; i<25; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.width = p.style.height = (Math.random()*4+2)+'px';
                p.style.left = Math.random()*100+'vw';
                p.style.animationDuration = (Math.random()*8+4)+'s';
                p.style.animationDelay = (Math.random()*5)+'s';
                partContainer.appendChild(p);
            }

            // LIFF åˆå§‹åŒ–èˆ‡è³‡æ ¼æª¢æŸ¥
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                userUID = profile.userId;

                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'check', userId: userUID }) });
                const data = await res.json();
                
                if (data.canPlay) {
                    document.getElementById('loading-overlay').style.display = 'none';
                } else {
                    document.getElementById('loading-text').innerHTML = "âŒ æ‚¨ä»Šæ—¥å·²é ˜å–éå¥½é‹å›‰ï¼";
                }
            } catch (e) {
                // è‹¥é–‹ç™¼ç’°å¢ƒç„¡æ³•è·‘ LIFFï¼Œ5ç§’å¾Œè‡ªå‹•éš±è—é®ç½©æ–¹ä¾¿æ¸¬è©¦è¦–è¦º
                setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 5000);
            }
        }

        function startSpin() {
            if (isSpinning) return;
            isSpinning = true;
            document.getElementById('spin-btn').classList.add('opacity-50', 'pointer-events-none');
            const winIdx = Math.floor(Math.random() * prizes.length);
            const deg = 3600 + (360 - (winIdx * 90) - 45); // éš¨æ©Ÿæ—‹è½‰ 10 åœˆä»¥ä¸Šä¸¦åœåœ¨æ­£ç¢ºå€åŸŸ

            gsap.to("#wheel-canvas", { 
                rotation: deg, duration: 5, ease: "back.out(0.5)", 
                onComplete: () => {
                    const prize = prizes[winIdx].name;
                    document.getElementById('win-name').innerText = prize;
                    const modal = document.getElementById('prize-modal');
                    modal.style.display = 'flex';
                    setTimeout(() => { modal.style.opacity = '1'; modal.querySelector('div').style.transform = 'scale(1)'; }, 10);
                    // ç´€éŒ„åˆ° GAS
                    fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'save', userId: userUID, prize: prize }) });
                }
            });
        }

        function closeModal() {
            liff.closeWindow();
        }

        window.onload = init;
    </script>
</body>
</html>
